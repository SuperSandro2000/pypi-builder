FROM {% if ARCH is defined %}{{ARCH}}/{% endif %}python:{% if PY_VERSION is defined %}{{PY_VERSION}}{% else %}3{% endif %}-{% if DIST is defined %}{{DIST}}{% else %}buster{% endif %}

{%- if DIST == "alpine" %}
# script and very common build dependencies.
# git is needed when a git repo is referenced in a requirements.txt
RUN apk add --no-progress bash g++ git make \
# libffi-dev and openssl-dev is needed for cryptography which in turn is needed for twine
  libffi-dev openssl-dev

RUN pip3 install twine wheel

{%- if "Kibitzr" or "lxml" in PIP %}
# depencies needed by lxml
RUN apk add --no-progress libxml2-dev libxslt-dev
{%- endif %}

{%- if "psycopg2-binary" in PIP %}
RUN apk add --no-progress postgresql-dev
{%- endif %}

{%- if "healthchecks" in PIP %}
RUN apk add --no-progress postgresql-dev
{%- endif %}

{%- endif %}

COPY [ "Makefile", "/data/" ]

VOLUME /data/packages
WORKDIR /data
CMD [ "make" ]
